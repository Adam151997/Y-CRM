// Y CRM - Prisma Schema
// PostgreSQL Database

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
}

// =============================================================================
// AUDIT TRAIL - Tracks ALL changes, including AI actions
// =============================================================================

model AuditLog {
  id            String   @id @default(uuid())
  orgId         String

  // What happened
  action        String   // CREATE, UPDATE, DELETE, VOICE_COMMAND, AI_EXECUTION
  module        String   // LEAD, CONTACT, ACCOUNT, TASK, NOTE, TICKET, etc.
  recordId      String?  // The affected record's ID

  // Who did it
  actorType     String   // USER, AI_AGENT, SYSTEM, API
  actorId       String?  // Clerk user ID if USER, null if AI_AGENT

  // Details
  previousState Json?    // Snapshot before change
  newState      Json?    // Snapshot after change
  metadata      Json?    // Additional context (voice transcript, AI reasoning, etc.)

  // Traceability
  requestId     String?  // Groups related operations (e.g., multi-step voice command)
  parentLogId   String?  // For nested operations

  createdAt     DateTime @default(now())

  @@index([orgId, createdAt])
  @@index([recordId])
  @@index([requestId])
  @@index([actorId])
}

// =============================================================================
// MULTI-TENANCY & ORGANIZATION
// =============================================================================

model Organization {
  id                  String   @id // Clerk Organization ID
  name                String
  slug                String   @unique
  plan                String   @default("FREE") // FREE, PRO, ENTERPRISE
  settings            Json     @default("{}")

  // Rate limiting
  aiCallsThisMonth    Int      @default(0)
  aiCallsLimit        Int      @default(100) // Based on plan

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations - Sales
  leads               Lead[]
  contacts            Contact[]
  accounts            Account[]
  opportunities       Opportunity[]
  
  // Relations - CS
  tickets             Ticket[]
  playbooks           Playbook[]
  renewals            Renewal[]
  
  // Relations - Marketing
  campaigns           Campaign[]
  segments            Segment[]
  forms               Form[]
  
  // Relations - Shared
  customFields        CustomFieldDefinition[]
  customModules       CustomModule[]
  dashboardConfigs    DashboardConfig[]
  pipelineStages      PipelineStage[]
  tasks               Task[]
  notes               Note[]
  activities          Activity[]
  documents           Document[]
  invoices            Invoice[]
  inventoryItems      InventoryItem[]

  // Relations - HR
  employees           Employee[]
  leaves              Leave[]
  payrolls            Payroll[]

  // Relations - RBAC
  roles               Role[]
  userRoles           UserRole[]

  // Relations - Integrations
  regularIntegrations RegularIntegration[]

  @@index([slug])
}

// =============================================================================
// RBAC - Role-Based Access Control
// =============================================================================

model Role {
  id          String       @id @default(cuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name        String       // "Admin", "Manager", "Sales Rep", "Read Only"
  description String?
  isDefault   Boolean      @default(false)  // Auto-assigned to new users
  isSystem    Boolean      @default(false)  // Can't be deleted (Admin role)
  
  permissions Permission[]
  userRoles   UserRole[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([orgId, name])
  @@index([orgId])
}

model Permission {
  id       String   @id @default(cuid())
  roleId   String
  role     Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  module   String   // "leads", "contacts", "accounts", "opportunities", "tasks", "documents", or custom module slug
  actions  String[] // ["view", "create", "edit", "delete"]
  fields   Json?    // { "view": ["name", "email"], "edit": ["status"] } - null = all fields
  
  // Record-level visibility
  recordVisibility String @default("ALL") // ALL, OWN_ONLY, UNASSIGNED

  @@unique([roleId, module])
  @@index([roleId])
}

model UserRole {
  id          String       @id @default(cuid())
  clerkUserId String       // Clerk user ID
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  roleId      String
  role        Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([clerkUserId, orgId])
  @@index([orgId])
  @@index([roleId])
}

// =============================================================================
// CRM CORE ENTITIES
// =============================================================================

model Lead {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Fixed fields (indexed, type-safe)
  firstName       String
  lastName        String
  email           String?
  phone           String?
  company         String?
  title           String?
  source          String?   // REFERRAL, WEBSITE, COLD_CALL, LINKEDIN, TRADE_SHOW, OTHER
  status          String    @default("NEW") // NEW, CONTACTED, QUALIFIED, CONVERTED, LOST

  // Pipeline
  pipelineStageId String?
  pipelineStage   PipelineStage? @relation(fields: [pipelineStageId], references: [id])

  // Dynamic fields (validated at runtime via Zod)
  customFields    Json      @default("{}")

  // Ownership
  assignedToId    String?   // Clerk user ID

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  convertedAt     DateTime?

  // Relations
  notes           Note[]
  tasks           Task[]
  activities      Activity[]
  documents       Document[]

  @@unique([orgId, email])
  @@index([orgId, status])
  @@index([orgId, assignedToId])
  @@index([orgId, createdAt])
  @@index([email])
}

model Contact {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  firstName       String
  lastName        String
  email           String?
  phone           String?
  title           String?
  department      String?

  // Link to Account
  accountId       String?
  account         Account? @relation(fields: [accountId], references: [id])

  customFields    Json     @default("{}")
  assignedToId    String?

  isPrimary       Boolean  @default(false) // Primary contact for account

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  notes           Note[]
  tasks           Task[]
  activities      Activity[]
  tickets         Ticket[]  // CS: Tickets from this contact
  invoices        Invoice[] // Invoices addressed to this contact

  @@unique([orgId, email])
  @@index([orgId])
  @@index([accountId])
}

model Account {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name            String
  industry        String?
  website         String?
  phone           String?
  
  // Address as JSON
  address         Json?    // { street, city, state, zip, country }

  // Financials
  annualRevenue   Decimal? @db.Decimal(15, 2)
  employeeCount   Int?
  
  // Classification
  type            String?  // PROSPECT, CUSTOMER, PARTNER, VENDOR
  rating          String?  // HOT, WARM, COLD

  customFields    Json     @default("{}")
  assignedToId    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations - Sales
  contacts        Contact[]
  opportunities   Opportunity[]
  notes           Note[]
  tasks           Task[]
  documents       Document[]
  activities      Activity[]      // Unified timeline
  
  // Relations - CS
  tickets         Ticket[]        // Support tickets
  health          AccountHealth?  // Health score record
  renewals        Renewal[]       // Contract renewals
  
  // Relations - Invoicing
  invoices        Invoice[]

  @@index([orgId])
  @@index([orgId, name])
  @@index([industry])
}

model Opportunity {
  id                  String    @id @default(uuid())
  orgId               String
  org                 Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name                String
  value               Decimal   @db.Decimal(15, 2)
  currency            String    @default("USD")
  probability         Int       @default(50) // 0-100

  accountId           String
  account             Account   @relation(fields: [accountId], references: [id])

  stageId             String
  stage               PipelineStage @relation(fields: [stageId], references: [id])

  expectedCloseDate   DateTime?
  actualCloseDate     DateTime?
  
  // Win/Loss tracking
  closedWon           Boolean?
  lostReason          String?

  customFields        Json      @default("{}")
  assignedToId        String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  notes               Note[]
  tasks               Task[]
  invoices            Invoice[]

  @@index([orgId, stageId])
  @@index([orgId, expectedCloseDate])
  @@index([accountId])
}

// =============================================================================
// INVOICING MODULE
// =============================================================================

model Invoice {
  id                  String    @id @default(uuid())
  orgId               String
  org                 Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Invoice identifier (auto-increment per org)
  invoiceNumber       String    // INV-0001, INV-0002, etc.
  
  // Status workflow
  status              String    @default("DRAFT") // DRAFT, SENT, VIEWED, PAID, PARTIALLY_PAID, OVERDUE, CANCELLED, VOID
  
  // Relations
  accountId           String
  account             Account   @relation(fields: [accountId], references: [id])
  contactId           String?
  contact             Contact?  @relation(fields: [contactId], references: [id])
  opportunityId       String?
  opportunity         Opportunity? @relation(fields: [opportunityId], references: [id])
  
  // Dates
  issueDate           DateTime  @default(now())
  dueDate             DateTime
  sentAt              DateTime?
  viewedAt            DateTime?
  paidAt              DateTime?
  
  // Financials
  currency            String    @default("USD")
  subtotal            Decimal   @db.Decimal(15, 2) @default(0)
  taxRate             Decimal?  @db.Decimal(5, 2)  // Percentage (e.g., 10.00 for 10%)
  taxAmount           Decimal   @db.Decimal(15, 2) @default(0)
  discountType        String?   // PERCENTAGE, FIXED
  discountValue       Decimal?  @db.Decimal(15, 2) // Either percentage or fixed amount
  discountAmount      Decimal   @db.Decimal(15, 2) @default(0)
  total               Decimal   @db.Decimal(15, 2) @default(0)
  amountPaid          Decimal   @db.Decimal(15, 2) @default(0)
  amountDue           Decimal   @db.Decimal(15, 2) @default(0)
  
  // Content
  notes               String?   @db.Text  // Notes to customer (appears on invoice)
  terms               String?   @db.Text  // Payment terms
  footer              String?   @db.Text  // Footer text
  
  // Billing address (snapshot at invoice creation)
  billingAddress      Json?     // { name, street, city, state, zip, country }
  
  // Metadata
  customFields        Json      @default("{}")
  
  // Attribution
  createdById         String
  createdByType       String    @default("USER") // USER, AI_AGENT
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  items               InvoiceItem[]
  payments            Payment[]

  @@unique([orgId, invoiceNumber])
  @@index([orgId, status])
  @@index([orgId, dueDate])
  @@index([orgId, issueDate])
  @@index([orgId, accountId])
  @@index([accountId])
  @@index([contactId])
  @@index([opportunityId])
}

model InvoiceItem {
  id                  String    @id @default(uuid())
  invoiceId           String
  invoice             Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Item details
  description         String
  quantity            Decimal   @db.Decimal(10, 2) @default(1)
  unitPrice           Decimal   @db.Decimal(15, 2)
  amount              Decimal   @db.Decimal(15, 2) // quantity * unitPrice

  // Optional: item code or SKU (for non-inventory items)
  itemCode            String?

  // Inventory Integration (optional - for inventory-linked items)
  inventoryItemId     String?
  inventoryItem       InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  priceAtSale         Decimal?  @db.Decimal(15, 2)  // Snapshot of inventory price at time of sale

  // Ordering
  sortOrder           Int       @default(0)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([invoiceId])
  @@index([invoiceId, sortOrder])
  @@index([inventoryItemId])
}

model Payment {
  id                  String    @id @default(uuid())
  orgId               String
  
  invoiceId           String
  invoice             Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Payment details
  amount              Decimal   @db.Decimal(15, 2)
  paymentDate         DateTime  @default(now())
  method              String    @default("BANK_TRANSFER") // CASH, CHECK, CREDIT_CARD, DEBIT_CARD, BANK_TRANSFER, PAYPAL, STRIPE, OTHER
  
  // Reference/tracking
  reference           String?   // Check number, transaction ID, etc.
  notes               String?   @db.Text
  
  // Attribution
  recordedById        String
  recordedByType      String    @default("USER") // USER, AI_AGENT
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([orgId])
  @@index([invoiceId])
  @@index([invoiceId, paymentDate])
}

// =============================================================================
// INVENTORY MODULE
// =============================================================================

model InventoryItem {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Core Fields
  name            String
  sku             String
  description     String?   @db.Text

  // Stock Management
  stockLevel      Int       @default(0)
  reorderLevel    Int       @default(0)    // Alert threshold for low stock
  unit            String    @default("pcs") // pcs, kg, liters, hours, etc.

  // Pricing
  unitPrice       Decimal   @db.Decimal(15, 2)
  costPrice       Decimal?  @db.Decimal(15, 2)  // For margin calculation

  // Organization
  category        String?
  tags            String[]  @default([])

  // Status
  isActive        Boolean   @default(true)

  // Attribution
  createdById     String
  createdByType   String    @default("USER") // USER, AI_AGENT

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  invoiceItems    InvoiceItem[]
  stockMovements  StockMovement[]

  @@unique([orgId, sku])
  @@index([orgId, isActive])
  @@index([orgId, category])
  @@index([orgId, stockLevel])  // For low stock queries
  @@index([orgId, name])
}

model StockMovement {
  id              String    @id @default(uuid())
  orgId           String

  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  // Movement Details
  type            String    // SALE, RESTOCK, ADJUSTMENT, RETURN, INITIAL, DAMAGE
  quantity        Int       // Positive for additions, negative for deductions
  previousLevel   Int       // Stock level before this movement
  newLevel        Int       // Stock level after this movement

  // Reference to related entity (if applicable)
  referenceType   String?   // INVOICE, MANUAL, IMPORT
  referenceId     String?   // Invoice ID if from sale

  // Details
  notes           String?   @db.Text
  reason          String?   // Reason for adjustment (e.g., "Damaged goods", "Inventory count correction")

  // Attribution
  createdById     String
  createdByType   String    @default("USER") // USER, AI_AGENT, SYSTEM

  createdAt       DateTime  @default(now())

  @@index([orgId, inventoryItemId])
  @@index([orgId, createdAt])
  @@index([orgId, type])
  @@index([referenceType, referenceId])
}

// =============================================================================
// CUSTOMER SUCCESS MODULES
// =============================================================================

model Ticket {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  // Ticket identifier (auto-increment per org would be ideal, using sequence)
  ticketNumber    Int       @default(autoincrement())
  
  // Core fields
  subject         String
  description     String?   @db.Text
  status          String    @default("NEW") // NEW, OPEN, PENDING, RESOLVED, CLOSED
  priority        String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  category        String?   // BUG, BILLING, FEATURE_REQUEST, QUESTION, GENERAL
  
  // Relations
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id])
  contactId       String?
  contact         Contact?  @relation(fields: [contactId], references: [id])
  
  // Assignment & Attribution
  assignedToId    String?   // CSM/Support agent user ID
  createdById     String
  createdByType   String    @default("USER") // USER, CONTACT, AI_AGENT
  
  // AI Analysis
  sentiment       String?   // POSITIVE, NEUTRAL, NEGATIVE
  tags            Json?     // ["Bug", "Billing", "Urgent"]
  aiSummary       String?   @db.Text // AI-generated summary
  
  // SLA & Resolution
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?
  resolvedById    String?
  resolution      String?   @db.Text
  
  // Satisfaction
  satisfactionScore Int?    // 1-5 CSAT rating
  satisfactionFeedback String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  messages        TicketMessage[]

  @@index([orgId, status])
  @@index([orgId, priority])
  @@index([orgId, accountId])
  @@index([orgId, assignedToId])
  @@index([orgId, createdAt])
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  content     String   @db.Text
  contentHtml String?  @db.Text  // Rich text version
  isInternal  Boolean  @default(false) // Internal notes vs customer-facing
  
  // Author
  authorId    String
  authorType  String   // USER, CONTACT, AI_AGENT
  authorName  String?  // Cached name for display
  
  // Attachments
  attachments Json?    // [{ name, url, size, type }]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ticketId])
  @@index([ticketId, createdAt])
}

model AccountHealth {
  id              String   @id @default(uuid())
  orgId           String
  
  accountId       String   @unique
  account         Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Overall Health Score (0-100)
  score           Int      @default(50)
  previousScore   Int?     // For trend calculation
  riskLevel       String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  
  // Score Components (each 0-100)
  engagementScore     Int  @default(50)  // Login frequency, feature usage
  supportScore        Int  @default(50)  // Ticket volume, resolution satisfaction
  relationshipScore   Int  @default(50)  // Contact frequency, meeting attendance
  financialScore      Int  @default(50)  // Payment history, expansion signals
  adoptionScore       Int  @default(50)  // Feature adoption, usage depth
  
  // Activity Metrics
  lastLoginAt         DateTime?
  lastContactAt       DateTime?
  lastMeetingAt       DateTime?
  openTicketCount     Int      @default(0)
  avgTicketResolution Int?     // Average resolution time in hours
  
  // Flags
  isAtRisk            Boolean  @default(false)
  riskReasons         Json?    // ["No login in 30 days", "High ticket volume"]
  
  // Metadata
  calculatedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId, riskLevel])
  @@index([orgId, score])
  @@index([orgId, isAtRisk])
}

model Playbook {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name            String   // "SaaS Onboarding", "Renewal 90-Day", "At-Risk Intervention"
  description     String?  @db.Text
  
  // Trigger configuration
  trigger         String   @default("MANUAL") // MANUAL, NEW_CUSTOMER, RENEWAL_APPROACHING, HEALTH_DROP, TICKET_ESCALATION
  triggerConfig   Json?    // { daysBeforeRenewal: 90 } or { healthScoreBelow: 40 }
  
  // Steps as JSON array
  // [{ order: 1, dayOffset: 0, title: "Kickoff Call", description: "...", taskType: "CALL", assigneeType: "CSM" }, ...]
  steps           Json     @default("[]")
  
  // Settings
  isActive        Boolean  @default(true)
  isTemplate      Boolean  @default(false) // Can be cloned
  
  createdById     String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Active instances
  runs            PlaybookRun[]

  @@index([orgId])
  @@index([orgId, isActive])
  @@index([orgId, trigger])
}

model PlaybookRun {
  id              String    @id @default(uuid())
  orgId           String
  
  playbookId      String
  playbook        Playbook  @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  accountId       String
  
  // Progress
  status          String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, CANCELLED, PAUSED
  currentStep     Int       @default(0)
  totalSteps      Int       @default(0)
  
  // Timing
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  pausedAt        DateTime?
  
  // Attribution
  startedById     String
  
  // Metadata - tracks generated task IDs, completion data
  metadata        Json?     // { taskIds: [...], stepCompletions: [...] }

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orgId, status])
  @@index([orgId, accountId])
  @@index([playbookId])
}

model Renewal {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id])
  
  // Contract Details
  contractName    String?
  contractValue   Decimal   @db.Decimal(15, 2)
  currency        String    @default("USD")
  
  // Contract Period
  startDate       DateTime
  endDate         DateTime
  
  // Renewal Tracking
  status          String    @default("UPCOMING") // UPCOMING, IN_PROGRESS, RENEWED, CHURNED, DOWNGRADED, EXPANDED
  renewalValue    Decimal?  @db.Decimal(15, 2)   // New contract value if renewed
  probability     Int       @default(50) // 0-100
  
  // Outcome
  outcome         String?   // RENEWED, CHURNED, DOWNGRADED, EXPANDED
  churnReason     String?   // COMPETITOR, BUDGET, NO_VALUE, PRODUCT_FIT, OTHER
  expansionAmount Decimal?  @db.Decimal(15, 2)
  
  // Ownership
  ownerUserId     String?   // CSM responsible
  
  // Notes & Activity
  notes           String?   @db.Text
  lastContactAt   DateTime?
  nextActionDate  DateTime?
  nextAction      String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orgId, status])
  @@index([orgId, endDate])
  @@index([orgId, ownerUserId])
  @@index([accountId])
}

// =============================================================================
// ACTIVITIES & RELATED ENTITIES
// =============================================================================

model Note {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  content         String   @db.Text

  // Attachments as JSON array: [{ name, url, size, type }]
  attachments     Json     @default("[]")

  // Polymorphic relation (only one should be set)
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  accountId       String?
  account         Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  opportunityId   String?
  opportunity     Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  employeeId      String?
  employee        Employee? @relation("EmployeeNotes", fields: [employeeId], references: [id], onDelete: Cascade)

  // Attribution
  createdById     String   // Clerk user ID or "AI_AGENT"
  createdByType   String   // USER, AI_AGENT

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
  @@index([leadId])
  @@index([contactId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([employeeId])
}

model Task {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  title           String
  description     String?   @db.Text
  dueDate         DateTime?
  priority        String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED

  // Task type
  taskType        String?   // CALL, EMAIL, MEETING, FOLLOW_UP, ONBOARDING, RENEWAL, OTHER

  // Workspace context
  workspace       String    @default("sales") // sales, cs, marketing, hr

  // Polymorphic relation
  leadId          String?
  lead            Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         Contact?  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  accountId       String?
  account         Account?  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  opportunityId   String?
  opportunity     Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  employeeId      String?
  employee        Employee? @relation("EmployeeTasks", fields: [employeeId], references: [id], onDelete: Cascade)

  assignedToId    String?
  createdById     String
  createdByType   String    // USER, AI_AGENT

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  @@index([orgId, status])
  @@index([orgId, dueDate])
  @@index([orgId, workspace])
  @@index([assignedToId, dueDate])
  @@index([leadId])
  @@index([contactId])
  @@index([accountId])
  @@index([employeeId])
}

model Activity {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Activity type - expanded for all workspaces
  type            String   // CALL, EMAIL, MEETING, VOICE_COMMAND, NOTE, TASK_COMPLETED,
                           // TICKET_CREATED, TICKET_RESOLVED, HEALTH_ALERT, 
                           // PLAYBOOK_STARTED, PLAYBOOK_COMPLETED, RENEWAL_UPDATED
  
  subject         String
  description     String?  @db.Text
  
  // Workspace context
  workspace       String   @default("sales") // sales, cs, marketing

  // For voice commands
  transcript      String?  @db.Text
  audioUrl        String?

  // Duration for calls/meetings (in minutes)
  duration        Int?

  // Polymorphic relation
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  accountId       String?
  account         Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  performedById   String
  performedByType String   // USER, AI_AGENT

  performedAt     DateTime @default(now())

  @@index([orgId, type])
  @@index([orgId, performedAt])
  @@index([orgId, workspace])
  @@index([leadId])
  @@index([contactId])
  @@index([accountId])
}

model Document {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name            String
  type            String   // INVOICE, CONTRACT, PROPOSAL, PRESENTATION, OTHER
  fileUrl         String
  fileKey         String   // R2 key
  fileSize        Int
  mimeType        String

  // Polymorphic relation
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  accountId       String?
  account         Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  uploadedById    String

  createdAt       DateTime @default(now())

  @@index([orgId])
  @@index([leadId])
  @@index([accountId])
}

// =============================================================================
// CUSTOM MODULES (User-Defined Modules)
// =============================================================================

model CustomModule {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name            String   // Display name: "Products"
  pluralName      String   // Plural: "Products"
  slug            String   // URL slug: "products"
  description     String?
  icon            String   @default("box") // Lucide icon name
  color           String?  // Brand color for the module

  // Module configuration
  labelField      String   @default("name") // Which field to use as the record label
  isActive        Boolean  @default(true)
  showInSidebar   Boolean  @default(true)
  displayOrder    Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  records         CustomModuleRecord[]
  fields          CustomFieldDefinition[]

  @@unique([orgId, slug])
  @@index([orgId])
  @@index([orgId, isActive])
}

model CustomModuleRecord {
  id              String   @id @default(uuid())
  orgId           String
  
  moduleId        String
  module          CustomModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // All field values stored as JSON
  data            Json     @default("{}")

  // Ownership & attribution
  assignedToId    String?
  createdById     String
  createdByType   String   @default("USER") // USER, AI_AGENT

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
  @@index([moduleId])
  @@index([moduleId, createdAt])
}

// =============================================================================
// CUSTOMIZATION & CONFIGURATION
// =============================================================================

model CustomFieldDefinition {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // For built-in modules (LEAD, CONTACT, etc.)
  module          String?  // LEAD, CONTACT, ACCOUNT, OPPORTUNITY (null if custom module)
  
  // For custom modules
  customModuleId  String?
  customModule    CustomModule? @relation(fields: [customModuleId], references: [id], onDelete: Cascade)

  fieldName       String   // Display name: "Industry"
  fieldKey        String   // JSON key: "industry"
  fieldType       String   // TEXT, NUMBER, DATE, SELECT, MULTISELECT, BOOLEAN, URL, EMAIL, PHONE, TEXTAREA, CURRENCY, PERCENT, RELATIONSHIP

  required        Boolean  @default(false)
  options         Json?    // For SELECT/MULTISELECT: ["Option 1", "Option 2"]
  defaultValue    Json?
  placeholder     String?
  helpText        String?
  
  // For RELATIONSHIP field type
  relatedModule   String?  // Module to link to (LEAD, CONTACT, or custom module slug)

  displayOrder    Int      @default(0)
  isActive        Boolean  @default(true)
  isSystem        Boolean  @default(false) // System fields can't be deleted

  // Schema evolution tracking (Fix #5)
  version         Int      @default(1)
  previousVersions Json?   // Track field definition changes

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([orgId, module, fieldKey])
  @@unique([orgId, customModuleId, fieldKey])
  @@index([orgId, module])
  @@index([orgId, customModuleId])
}

model PipelineStage {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name            String
  module          String   // LEAD, OPPORTUNITY
  order           Int
  color           String?  // Hex color for UI
  
  // For opportunity stages
  probability     Int?     // Default win probability (0-100)
  isWon           Boolean  @default(false)
  isLost          Boolean  @default(false)

  leads           Lead[]
  opportunities   Opportunity[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([orgId, module, name])
  @@index([orgId, module])
}

model DashboardConfig {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId          String   // Clerk user ID
  
  // Workspace-specific dashboard
  workspace       String   @default("sales") // sales, cs, marketing

  layout          Json     // Grid layout: [{ i: "widget-1", x: 0, y: 0, w: 2, h: 2 }]
  widgets         Json     // Widget configs: [{ id: "widget-1", type: "pipeline", settings: {} }]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([orgId, userId, workspace])
}

// =============================================================================
// USAGE TRACKING & RATE LIMITING
// =============================================================================

model UsageRecord {
  id              String   @id @default(uuid())
  orgId           String
  userId          String?

  type            String   // AI_CALL, TRANSCRIPTION, VOICE_MINUTES, EMBEDDING
  count           Int      @default(1)
  metadata        Json?    // Additional details (model used, tokens, etc.)

  createdAt       DateTime @default(now())

  @@index([orgId, type, createdAt])
  @@index([userId, type, createdAt])
}

// =============================================================================
// INTEGRATIONS (Composio)
// =============================================================================

model Integration {
  id              String   @id @default(uuid())
  orgId           String
  
  provider        String   // gmail, googlecalendar, slack, github, etc.
  status          String   @default("PENDING") // PENDING, ACTIVE, ERROR, DISCONNECTED
  connectionId    String?  // Composio connection ID
  
  // OAuth tokens (encrypted in production)
  accessToken     String?  @db.Text
  refreshToken    String?  @db.Text
  tokenExpiresAt  DateTime?
  
  metadata        Json     @default("{}") // Additional provider-specific data
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([orgId, provider])
  @@index([orgId])
  @@index([provider, status])
}

// =============================================================================
// MARKETING MODULES
// =============================================================================

model Campaign {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?   @db.Text
  type            String    // EMAIL, SOCIAL, EVENT, WEBINAR, SMS, ADS
  status          String    @default("DRAFT") // DRAFT, SCHEDULED, ACTIVE, PAUSED, COMPLETED, CANCELLED
  
  // Targeting
  segmentId       String?
  segment         Segment?  @relation(fields: [segmentId], references: [id])
  
  // Schedule
  scheduledAt     DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Content
  subject         String?   // Email subject or campaign headline
  content         Json?     // Rich content, template data, or configuration
  settings        Json?     // Campaign-specific settings
  
  // Metrics
  metrics         Json?     // { sent, delivered, opened, clicked, converted, bounced, unsubscribed }
  
  // Budget (for ads)
  budget          Decimal?  @db.Decimal(15, 2)
  spent           Decimal?  @db.Decimal(15, 2)
  
  // Attribution
  createdById     String
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orgId, status])
  @@index([orgId, type])
  @@index([segmentId])
}

model Segment {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  
  // Target entity type: which records this segment evaluates
  targetEntity    String   @default("CONTACT") // CONTACT, LEAD
  
  // Dynamic rules for segment membership
  // [{ field: "industry", operator: "equals", value: "Technology" }, ...]
  rules           Json     @default("[]")
  
  // Rule logic: AND (all rules must match) or OR (any rule matches)
  ruleLogic       String   @default("AND") // AND, OR
  
  // Computed member count (updated periodically)
  memberCount     Int      @default(0)
  lastCalculatedAt DateTime?
  
  // Segment type
  type            String   @default("DYNAMIC") // DYNAMIC, STATIC
  
  // For static segments - manually added member IDs
  staticMembers   Json?    // ["contact-id-1", "contact-id-2", ...]
  
  isActive        Boolean  @default(true)
  
  // Relations
  campaigns       Campaign[]
  members         SegmentMember[]
  
  createdById     String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
  @@index([orgId, isActive])
  @@index([orgId, targetEntity])
}

// Tracks actual segment members (computed from rules or manually added)
model SegmentMember {
  id          String   @id @default(uuid())
  segmentId   String
  segment     Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  
  // Polymorphic - one of these will be set based on segment's targetEntity
  contactId   String?
  leadId      String?
  
  addedAt     DateTime @default(now())
  
  @@unique([segmentId, contactId])
  @@unique([segmentId, leadId])
  @@index([segmentId])
  @@index([contactId])
  @@index([leadId])
}

model Form {
  id              String   @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  
  // Form configuration
  // [{ id, type, label, required, placeholder, options, validation }, ...]
  fields          Json     @default("[]")
  
  // Form settings
  settings        Json?    // { redirectUrl, notifyEmails, confirmationMessage, styling }
  
  // Lead/Contact creation settings
  createLead      Boolean  @default(true)
  assignToUserId  String?  // Auto-assign new leads to this user
  leadSource      String   @default("FORM") // Source value for created leads
  
  // Stats
  views           Int      @default(0)
  submissions     Int      @default(0)
  conversionRate  Decimal? @db.Decimal(5, 2) // Calculated: submissions/views * 100
  
  // Status
  isActive        Boolean  @default(true)
  
  // Public access
  slug            String?  // For public form URL
  
  createdById     String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Submissions
  formSubmissions FormSubmission[]

  @@unique([orgId, slug])
  @@index([orgId])
  @@index([orgId, isActive])
}

model FormSubmission {
  id              String   @id @default(uuid())
  orgId           String
  
  formId          String
  form            Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  // Submitted data
  data            Json     // { fieldId: value, ... }
  
  // Created lead/contact reference
  leadId          String?
  contactId       String?
  
  // Submission metadata
  ipAddress       String?
  userAgent       String?
  referrer        String?
  
  createdAt       DateTime @default(now())

  @@index([formId])
  @@index([formId, createdAt])
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model Notification {
  id              String   @id @default(uuid())
  orgId           String
  userId          String   // Target user for this notification
  
  // Notification content
  type            String   // LEAD_CREATED, TASK_ASSIGNED, TASK_COMPLETED, OPPORTUNITY_WON, TICKET_CREATED, etc.
  title           String
  message         String?
  
  // Related entity (optional)
  entityType      String?  // LEAD, CONTACT, ACCOUNT, TASK, OPPORTUNITY, TICKET
  entityId        String?
  
  // Status
  isRead          Boolean  @default(false)
  readAt          DateTime?
  
  // Metadata
  metadata        Json?    // Additional context data
  
  createdAt       DateTime @default(now())

  @@index([orgId, userId, isRead])
  @@index([orgId, userId, createdAt])
  @@index([userId, isRead])
}

// =============================================================================
// MCP INTEGRATIONS (External MCP Server Connections)
// =============================================================================

model MCPIntegration {
  id              String   @id @default(uuid())
  orgId           String
  
  // Server identification
  name            String   // Display name: "GitHub MCP", "Notion MCP"
  description     String?
  
  // Connection configuration
  transportType   String   @default("SSE") // SSE, STDIO
  
  // For SSE transport
  serverUrl       String?  // https://mcp-server.example.com/sse
  
  // For STDIO transport
  command         String?  // e.g., "npx", "node"
  args            Json?    // e.g., ["-y", "@modelcontextprotocol/server-github"]
  env             Json?    // Environment variables (encrypted in production)
  
  // Authentication
  authType        String?  // NONE, API_KEY, BEARER, CUSTOM_HEADER
  authConfig      Json?    // { apiKey, headerName, headerValue } - encrypted
  
  // Connection state
  status          String   @default("DISCONNECTED") // DISCONNECTED, CONNECTING, CONNECTED, ERROR
  lastConnectedAt DateTime?
  lastError       String?
  
  // Server capabilities (populated after connection)
  capabilities    Json?    // { tools: true, resources: true, prompts: true }
  toolCount       Int      @default(0)
  
  // Settings
  isEnabled       Boolean  @default(true)
  autoConnect     Boolean  @default(true) // Auto-connect on startup
  
  createdById     String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([orgId, name])
  @@index([orgId])
  @@index([orgId, isEnabled])
  @@index([orgId, status])
}

// =============================================================================
// HUMAN RESOURCES MODULES
// =============================================================================

model Employee {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Personal Information
  firstName       String
  lastName        String
  email           String
  phone           String?
  dateOfBirth     DateTime?

  // Address
  address         Json?     // { street, city, state, zip, country }

  // Employment Details
  employeeId      String    // Employee ID (e.g., EMP-001)
  department      String?
  position        String?
  employmentType  String    @default("FULL_TIME") // FULL_TIME, PART_TIME, CONTRACT, INTERN
  status          String    @default("ACTIVE") // ACTIVE, ON_LEAVE, TERMINATED, RESIGNED

  // Dates
  joinDate        DateTime
  terminationDate DateTime?

  // Compensation
  salary          Decimal?  @db.Decimal(15, 2)
  salaryType      String    @default("MONTHLY") // HOURLY, WEEKLY, BIWEEKLY, MONTHLY, ANNUAL
  currency        String    @default("USD")

  // Documents & Custom Fields
  customFields    Json      @default("{}")
  documents       Json      @default("[]") // [{ name, url, type, uploadedAt }]

  // Hierarchy & Assignment
  managerId       String?   // Reference to another employee (manager)
  assignedToId    String?   // HR personnel responsible for this employee

  // Attribution
  createdById     String
  createdByType   String    @default("USER") // USER, AI_AGENT

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  leaves          Leave[]
  payrolls        Payroll[]
  tasks           Task[]    @relation("EmployeeTasks")
  notes           Note[]    @relation("EmployeeNotes")

  @@unique([orgId, employeeId])
  @@unique([orgId, email])
  @@index([orgId, status])
  @@index([orgId, department])
  @@index([orgId, assignedToId])
  @@index([orgId, createdAt])
}

model Leave {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Employee Reference
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Leave Details
  type            String    // ANNUAL, SICK, UNPAID, MATERNITY, PATERNITY, EMERGENCY, BEREAVEMENT, OTHER
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED

  // Dates
  startDate       DateTime
  endDate         DateTime
  days            Decimal   @db.Decimal(5, 2) // Total days (can be half days)

  // Reason & Notes
  reason          String?   @db.Text

  // Approval Workflow
  approvedById    String?   // User who approved/rejected
  approvedAt      DateTime?
  rejectionReason String?

  // Custom Fields
  customFields    Json      @default("{}")

  // Attribution
  createdById     String
  createdByType   String    @default("USER") // USER, AI_AGENT

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orgId, status])
  @@index([orgId, employeeId])
  @@index([orgId, startDate])
  @@index([orgId, type])
  @@index([employeeId, status])
}

model Payroll {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Employee Reference
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Pay Period
  payPeriod       String    // e.g., "2024-01", "2024-W01", etc.
  startDate       DateTime
  endDate         DateTime

  // Compensation Breakdown
  baseSalary      Decimal   @db.Decimal(15, 2)
  overtime        Decimal   @db.Decimal(15, 2) @default(0)
  bonus           Decimal   @db.Decimal(15, 2) @default(0)
  commission      Decimal   @db.Decimal(15, 2) @default(0)
  allowances      Decimal   @db.Decimal(15, 2) @default(0) // Housing, transport, etc.
  grossPay        Decimal   @db.Decimal(15, 2)

  // Deductions
  taxDeduction    Decimal   @db.Decimal(15, 2) @default(0)
  insuranceDeduction Decimal @db.Decimal(15, 2) @default(0)
  retirementDeduction Decimal @db.Decimal(15, 2) @default(0)
  otherDeductions Decimal   @db.Decimal(15, 2) @default(0)
  totalDeductions Decimal   @db.Decimal(15, 2) @default(0)

  // Net Pay
  netPay          Decimal   @db.Decimal(15, 2)
  currency        String    @default("USD")

  // Status & Payment
  status          String    @default("DRAFT") // DRAFT, PENDING, APPROVED, PROCESSED, PAID
  paymentDate     DateTime?
  paymentMethod   String?   // BANK_TRANSFER, CHECK, CASH

  // Bank Details (snapshot for this payroll)
  bankDetails     Json?     // { bankName, accountNumber, routingNumber }

  // Notes
  notes           String?   @db.Text
  customFields    Json      @default("{}")

  // Attribution
  createdById     String
  createdByType   String    @default("USER") // USER, AI_AGENT
  approvedById    String?
  approvedAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([orgId, employeeId, payPeriod])
  @@index([orgId, status])
  @@index([orgId, payPeriod])
  @@index([orgId, paymentDate])
  @@index([employeeId, payPeriod])
}

// =============================================================================
// API KEYS (For MCP Server Access)
// =============================================================================

model APIKey {
  id          String    @id @default(uuid())
  orgId       String
  
  // Key identification
  name        String    // Display name: "Production MCP Key", "Development Key"
  description String?
  
  // Key storage (never store the actual key, only hash)
  keyHash     String    // SHA-256 hash of the full key
  keyPrefix   String    // First 12 chars for identification (e.g., "ycrm_abc123")
  
  // Permissions
  scopes      String[]  // ["mcp:read", "mcp:write", "mcp:admin"]
  
  // Usage tracking
  lastUsedAt  DateTime?
  usageCount  Int       @default(0)
  
  // Lifecycle
  expiresAt   DateTime? // Null = never expires
  isActive    Boolean   @default(true)
  revokedAt   DateTime?
  revokedById String?   // User who revoked the key
  
  // Attribution
  createdById String
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([keyHash])
  @@index([orgId])
  @@index([orgId, isActive])
  @@index([keyPrefix])
}

// =============================================================================
// REGULAR INTEGRATIONS (Webhooks & API Connections)
// =============================================================================

model RegularIntegration {
  id              String    @id @default(uuid())
  orgId           String
  org             Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Integration identification
  name            String    // Display name: "Courier Webhook", "Zapier Integration"
  description     String?

  // Integration type
  type            String    // webhook_outgoing, webhook_incoming, api

  // Configuration (encrypted sensitive fields)
  config          Json      // { url, headers, authType, authConfig (encrypted) }

  // For webhooks - which events trigger this integration
  events          String[]  // ["invoice.created", "lead.created", etc.]

  // State
  isEnabled       Boolean   @default(true)

  // Stats
  lastTriggeredAt DateTime?
  successCount    Int       @default(0)
  failureCount    Int       @default(0)
  lastError       String?

  // For incoming webhooks - unique URL token
  webhookToken    String?   @unique

  // Attribution
  createdById     String    // Clerk user ID

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([orgId, name])
  @@index([orgId])
  @@index([orgId, isEnabled])
  @@index([orgId, type])
  @@index([webhookToken])
}

// Webhook delivery log for tracking outgoing webhook attempts
model WebhookDelivery {
  id              String    @id @default(uuid())
  orgId           String

  integrationId   String

  // Event that triggered this delivery
  eventType       String    // e.g., "invoice.created"
  eventId         String?   // Reference to the entity that triggered the event

  // Request details
  requestUrl      String
  requestHeaders  Json?
  requestBody     Json?

  // Response details
  responseStatus  Int?
  responseBody    String?   @db.Text

  // Timing
  attemptedAt     DateTime  @default(now())
  duration        Int?      // Response time in ms

  // Retry tracking
  attemptNumber   Int       @default(1)
  nextRetryAt     DateTime?

  // Status
  status          String    @default("PENDING") // PENDING, SUCCESS, FAILED, RETRYING
  errorMessage    String?

  @@index([integrationId])
  @@index([orgId, eventType])
  @@index([status, nextRetryAt])
}
